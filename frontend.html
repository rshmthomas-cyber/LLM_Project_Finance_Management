<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Card Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 30px 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    }
    
    h1 {
        color: #11998e;
        font-size: 2.5em;
        text-align: center;
        margin-bottom: 10px;
    }
    
    .subtitle {
        color: #555;
        text-align: center;
        margin-bottom: 30px;
        font-size: 1.1em;
    }
    
    /* Upload Section - Responsive */
    .upload-section {
        background: #f0fffc;
        padding: 30px 20px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 30px;
        border: 2px dashed #11998e;
    }
    
    .upload-section h2 {
        color: #11998e;
        margin-bottom: 15px;
        font-size: 1.6em;
    }
    
    .upload-btn, .demo-btn {
        background: #11998e;
        color: white;
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        cursor: pointer;
        margin: 8px;
        transition: all 0.3s;
        min-width: 180px;
    }
    
    .upload-btn:hover, .demo-btn:hover {
        background: #0d7a6d;
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(17,153,142,0.4);
    }
    
    /* Metrics Grid - Fully Responsive */
    .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
        margin: 40px 0;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 25px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(17,153,142,0.3);
    }
    
    .metric-value {
        font-size: 2.2em;
        font-weight: bold;
        margin: 12px 0;
    }
    
    /* Charts - Stack on mobile */
    .charts {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        margin: 40px 0;
    }
    
    @media (min-width: 768px) {
        .charts {
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        }
    }
    
    .chart-container {
        background: #f0fffc;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    /* Insights Section */
    .insights {
        background: #f0fffc;
        padding: 30px 25px;
        border-radius: 16px;
        margin: 30px 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    }
    
    .insight-section h3 {
        color: #11998e;
        margin: 25px 0 15px 0;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .insight-section ul {
        list-style: none;
    }
    
    .insight-section li {
        padding: 14px 16px;
        margin: 10px 0;
        background: white;
        border-radius: 10px;
        border-left: 5px solid #11998e;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        font-size: 1.05em;
    }
    
    .concern {
        background: #fff8e1;
        padding: 18px;
        border-radius: 12px;
        border-left: 5px solid #ffb300;
        margin-top: 25px;
        font-size: 1.1em;
        color: #856404;
    }
    
    /* Status messages */
    .status {
        margin: 20px 0;
        padding: 18px;
        border-radius: 12px;
        text-align: center;
        font-weight: 500;
    }
    
    /* Mobile adjustments */
    @media (max-width: 600px) {
        .container { padding: 20px 15px; border-radius: 16px; }
        h1 { font-size: 2.1em; }
        .upload-btn, .demo-btn { 
            display: block; 
            width: 90%; 
            margin: 10px auto; 
        }
        .metric-card { padding: 20px; }
        .metric-value { font-size: 1.9em; }
    }
    
    .spinner {
        border: 4px solid #f0fffc;
        border-top: 4px solid #11998e;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ Credit Card Analyzer</h1>
        <p class="subtitle">AI-powered expense analysis using Gemini</p>
        
        <div class="upload-section">
            <h2>Upload Your Statement</h2>
            <p>Upload a PDF credit card statement or try the demo</p>
            
            <input type="file" id="fileInput" accept=".pdf">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÑ Choose PDF File
            </button>
            <button class="demo-btn" onclick="loadDemo()">
                üéÆ Try Demo Data
            </button>
            
            <div id="fileName" style="margin-top: 10px; color: #666;"></div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="results" class="results">
            <h2>üìä Analysis Results</h2>
            
            <div class="metrics" id="metrics"></div>
            
            <div class="charts">
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="merchantChart"></canvas>
                </div>
            </div>
            
            <div class="insights" id="insights"></div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        let CURRENCY_SYMBOL = '‚Çπ';  // Default to Rupees
        let CURRENCY_CODE = 'INR';
        
        // Fetch currency setting from API on page load
        async function initializeCurrency() {
            try {
                const response = await fetch(`${API_URL}/`);
                const data = await response.json();
                if (data.currency_symbol) {
                    CURRENCY_SYMBOL = data.currency_symbol;
                }
                if (data.currency) {
                    CURRENCY_CODE = data.currency;
                }
                console.log(`Currency initialized: ${CURRENCY_CODE} (${CURRENCY_SYMBOL})`);
            } catch (err) {
                console.log('Using default currency: INR (‚Çπ)');
            }
        }
        
        // Initialize on page load
        initializeCurrency();
        
        // Format currency with Indian locale for INR
        function formatCurrency(amount) {
            const locale = CURRENCY_CODE === 'INR' ? 'en-IN' : 'en-US';
            return `${CURRENCY_SYMBOL}${amount.toLocaleString(locale, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }
        
        // File selection handler
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `Selected: ${file.name}`;
                await uploadFile(file);
            }
        });
        
        // Upload and analyze PDF
        async function uploadFile(file) {
            showStatus('loading', '‚è≥ Analyzing your statement... This may take 30-60 seconds');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_URL}/api/analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Analysis failed');
                }
                
                const data = await response.json();
                showStatus('success', `‚úÖ Successfully analyzed ${data.transaction_count} transactions!`);
                displayResults(data);
                
            } catch (error) {
                showStatus('error', `‚ùå Error: ${error.message}`);
                console.error(error);
            }
        }
        
        // Load demo data
        async function loadDemo() {
            showStatus('loading', '‚è≥ Loading demo data...');
            
            try {
                const response = await fetch(`${API_URL}/api/demo`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                showStatus('success', '‚úÖ Demo data loaded successfully!');
                displayResults(data);
                
            } catch (error) {
                showStatus('error', `‚ùå Error: ${error.message}`);
            }
        }
        
        // Display status message
        function showStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'loading') {
                statusEl.innerHTML = `<div class="spinner"></div><p>${message}</p>`;
            } else {
                statusEl.innerHTML = message;
            }
        }
        
        // Display analysis results
        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            // Display metrics
            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Spent</div>
                    <div class="metric-value">${formatCurrency(data.summary.total_spent)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Transactions</div>
                    <div class="metric-value">${data.summary.transaction_count}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average</div>
                    <div class="metric-value">${formatCurrency(data.summary.average_transaction)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Top Merchant</div>
                    <div class="metric-value" style="font-size: 1.2em;">${data.summary.top_merchant}</div>
                </div>
            `;
            document.getElementById('metrics').innerHTML = metricsHTML;
            
            // Display charts
            displayCategoryChart(data.summary.by_category);
            displayMerchantChart(data.transactions);
            
            // Display insights
            displayInsights(data.insights);
        }
        
        // Category pie chart
        let categoryChartInstance = null;
        function displayCategoryChart(categories) {
            const ctx = document.getElementById('categoryChart');
            
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            categoryChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Spending by Category',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Top merchants bar chart
        let merchantChartInstance = null;
        function displayMerchantChart(transactions) {
            const merchantTotals = {};
            transactions.forEach(t => {
                merchantTotals[t.merchant] = (merchantTotals[t.merchant] || 0) + t.amount;
            });
            
            const sorted = Object.entries(merchantTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const ctx = document.getElementById('merchantChart');
            
            if (merchantChartInstance) {
                merchantChartInstance.destroy();
            }
            
            merchantChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: `Total Spent (${CURRENCY_SYMBOL})`,
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top Merchants',
                            font: { size: 16 }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Display AI insights
        function displayInsights(insights) {
            const insightsHTML = `
                <h2> AI-Powered Insights</h2>
                
                <div class="insight-section">
                    <h3>üìå Key Observations</h3>
                    <ul>
                        ${insights.observations.map(obs => `<li>${obs}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="insight-section">
                    <h3>üí° Recommendations</h3>
                    <ul>
                        ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="concern">
                    <strong>‚ö†Ô∏è Area to Monitor:</strong> ${insights.concern}
                </div>
            `;
            
            document.getElementById('insights').innerHTML = insightsHTML;
        }
    </script>
</body>
</html>